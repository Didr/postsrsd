#!@BATS_EXECUTABLE@

POSTSRSD="@POSTSRSD_EXECUTABLE@"
FAKETIME="@FAKETIME_EXECUTABLE@"

start_postsrsd_at()
{
    local faketime="$1"
    shift
    echo "tops3cr3t" > "$BATS_TMPDIR/postsrsd.secret"
    cat > "$BATS_TMPDIR/postsrsd.conf" <<EOF
    domains = { "example.com" }
    socketmap = inet:localhost:9999
    keep-alive = 2
    secrets-file = $BATS_TMPDIR/postsrsd.secret
    chroot-dir = ""
    unprivileged-user = ""
EOF
    "$FAKETIME" "$faketime" "$POSTSRSD" -D -p "$BATS_TMPDIR/postsrsd.pid" -C "$BATS_TMPDIR/postsrsd.conf" "$@"
}

stop_postsrsd()
{
    if [ -r "$BATS_TMPDIR/postsrsd.pid" ] && kill -0 $(< "$BATS_TMPDIR/postsrsd.pid") &>/dev/null
    then
        kill -TERM $(< "$BATS_TMPDIR/postsrsd.pid")
    fi
    rm -f "$BATS_TMPDIR/postsrsd."*
}

teardown()
{
    stop_postsrsd
}

@test "SRS forward rewrite" {
    start_postsrsd_at "2020-01-01 00:01:00 UTC"
    exec 9<>/dev/tcp/127.0.0.1/9999
    printf>&9 "24:forward test@example.com,"
    read<&9 -N 12 line
    [[ "$line" = "9:NOTFOUND ," ]]
    printf>&9 "28:forward test@otherdomain.com,"
    read<&9 -N 52 line
    echo $line | hd
    [[ "$line" = "48:OK SRS0=vmyz=2W=otherdomain.com=test@example.com," ]]
}
